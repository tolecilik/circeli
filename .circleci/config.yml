version: 2.1

jobs:
  run-xrdp-cloudflare:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Instalasi XRDP + XFCE
          command: |
            sudo apt-get update
            sudo apt-get install -y xrdp xfce4 wget
            # aktifkan service XRDP
            sudo systemctl enable xrdp
            sudo service xrdp start
            # buat password login
            echo "circleci:circleci" | sudo chpasswd

      - run:
          name: Instalasi Cloudflared
          command: |
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            cloudflared --version

      - run:
          name: Jalankan Cloudflare Tunnel (latar belakang)
          background: true
          command: |
            # Pipe log ke file DAN tampilkan ke console
            cloudflared tunnel --url tcp://localhost:3389 --loglevel info | tee tunnel.log

      - run:
          name: Tampilkan URL Publik Cloudflare Tunnel
          command: |
            echo "Menunggu tunnel aktif..."
            for i in {1..20}; do
              if grep -E "trycloudflare.com" tunnel.log; then
                echo "‚úÖ Tunnel publik ditemukan:"
                grep -E "tcp://.*trycloudflare.com" tunnel.log
                break
              fi
              echo "‚è≥ Belum muncul... tunggu 5 detik lagi."
              sleep 5
            done
            echo "üìú Log tunnel (debug):"
            cat tunnel.log | tail -n 20

      - run:
          name: Jaga‚ÄØXRDP‚ÄØdan‚ÄØTunnel‚ÄØtetap aktif
          command: |
            echo "‚úÖ XRDP via Cloudflare aktif."
            echo "üåê Gunakan URL di atas pada Remote Desktop Client (user: circleci / pass: circleci)."
            echo "üïí Container ini akan bertahan hingga kamu cancel job di dashboard."
            # Loop abadi + heartbeat agar tidak idle timeout
            while true; do
              echo "[KEEPALIVE] XRDP aktif - $(date)"
              sleep 99999999
            done

workflows:
  version: 2
  run:
    jobs:
      - run-xrdp-cloudflare
