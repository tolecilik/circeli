version: 2.1

jobs:
  run-xrdp-ngrok:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Install XRDP + XFCE + Ngrok
          command: |
            sudo apt-get update
            sudo apt-get install -y xrdp xfce4 wget unzip net-tools curl
            # buat password user bawaan
            echo "circleci:circleci" | sudo chpasswd
            # unduh dan konfigurasi ngrok
            wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
            unzip ngrok-stable-linux-amd64.zip -d ~/
            ~/ngrok config add-authtoken "$NGROK_AUTHTOKEN"

      - run:
          name: Jalankan XRDP manual (tanpa systemd)
          background: true
          command: |
            sudo /usr/sbin/xrdp-sesman &
            sudo /usr/sbin/xrdp --nodaemon &
            sleep 5
            sudo netstat -tlnp | grep 3389 || echo "âš ï¸ Port 3389 belum listening"

      - run:
          name: Jalankan Ngrok tunnel
          background: true
          command: |
            ~/ngrok tcp 3389 > /tmp/ngrok.log &
            sleep 10

      - run:
          name: Tampilkan alamat publik Ngrok
          command: |
            echo "ğŸ” Mencari alamat Ngrokâ€¯TCP..."
            # tampilkan baris dengan tcp:// dari log
            grep -E "tcp://" /tmp/ngrok.log || {
              echo "âš ï¸ Belum terdeteksi, coba cek API lokalâ€¯(4040)â€¦"
              curl -s http://localhost:4040/api/tunnels || true
            }

      - run:
          name: Keepalive agar job tetap hidup
          command: |
            echo "âœ…â€¯XRDPâ€¯&â€¯Ngrokâ€¯aktif!"
            echo "Gunakan alamat tcp://â€¦ pada Remoteâ€¯Desktopâ€¯Client"
            echo "Usernameâ€¯:â€¯circleci   Passwordâ€¯:â€¯circleci"
            echo "Jobâ€¯akanâ€¯aktif hinggaâ€¯anda Cancelâ€¯manual."
            while true; do
              echo "[KEEPALIVE] XRDPâ€¯aktifâ€¯-â€¯$(date)"
              sleepâ€¯300
            done

workflows:
  version: 2
  run:
    jobs:
      - run-xrdp-ngrok
