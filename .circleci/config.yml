version: 2.1

jobs:
  run-xrdp-cloudflare:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Install XRDP + XFCE
          command: |
            sudo apt-get update
            sudo apt-get install -y xrdp xfce4 wget net-tools
            echo "circleci:circleci" | sudo chpasswd

      - run:
          name: Install cloudflared
          command: |
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            cloudflared --version

      - run:
          name: Start XRDP daemon manual (tanpa systemd)
          background: true
          command: |
            sudo /usr/sbin/xrdp-sesman &
            sudo /usr/sbin/xrdp --nodaemon & 
            sleep 5
            sudo netstat -tlnp | grep 3389 || echo "‚ö†Ô∏è Port 3389 belum listening"

      - run:
          name: Jalankan Cloudflare Tunnel & tampilkan URL
          command: |
            echo "Menunggu XRDP siap..."
            for i in {1..10}; do
              if sudo netstat -tlnp | grep 3389; then
                echo "‚úÖ XRDP listening di 3389"
                break
              fi
              sleep 2
            done
            echo "üöÄ Menjalankan Cloudflare tunnel..."
            # Jalankan hingga selesai (di foreground), biar output langsung kelihatan di log CircleCI
            cloudflared tunnel --url tcp://localhost:3389 --loglevel info &
            # Tunggu sampai alamat publik muncul
            for i in {1..40}; do
              line=$(grep -E "trycloudflare.com" <<< "$(sudo pkill -0 cloudflared >/dev/null 2>&1 || true; ps aux | grep -m1 cloudflared; sleep 1; echo)")
              if test -n "$line"; then
                break
              fi
              grep -E "trycloudflare.com" cloudflared-output.log 2>/dev/null && break
              sleep 2
            done

      - run:
          name: Keepalive job
          command: |
            echo "‚úÖ XRDP & Cloudflare aktif. Gunakan URL di log yang menampilkan 'trycloudflare.com'"
            echo "User: circleci | Password: circleci"
            while true; do
              echo "[KEEPALIVE] XRDP aktif - $(date)"
              sleep 300
            done

workflows:
  version: 2
  run:
    jobs:
      - run-xrdp-cloudflare
