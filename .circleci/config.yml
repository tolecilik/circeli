version: 2.1

jobs:
  run-xrdp-cloudflare:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout

      - run:
          name: Install XRDP + XFCE
          command: |
            sudo apt-get update
            sudo apt-get install -y xrdp xfce4 wget net-tools
            echo "circleci:circleci" | sudo chpasswd

      - run:
          name: Install cloudflared
          command: |
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            cloudflared --version

      - run:
          name: Start XRDP manually (tanpa systemd)
          background: true
          command: |
            sudo /usr/sbin/xrdp-sesman &
            sudo /usr/sbin/xrdp --nodaemon &
            sleep 5
            sudo netstat -tlnp | grep 3389 || echo "‚ö†Ô∏è Port 3389 belum listening"

      - run:
          name: Jalankan Cloudflare Tunnel
          background: true
          command: |
            echo "Menunggu XRDP siap..."
            for i in {1..10}; do
              if sudo netstat -tlnp | grep 3389; then
                echo "‚úÖ XRDP listening di 3389"
                break
              fi
              sleep 2
            done
            echo "üöÄ Menjalankan Cloudflare tunnel..."
            cloudflared tunnel --url tcp://localhost:3389 --loglevel info | tee /tmp/tunnel.log

      - run:
          name: Tampilkan URL publik Cloudflare
          command: |
            echo "Menunggu tunnel aktif..."
            for i in {1..30}; do
              if grep -E "trycloudflare.com" /tmp/tunnel.log; then
                echo "‚úÖ Tunnel publik ditemukan:"
                grep -E "tcp://.*trycloudflare.com" /tmp/tunnel.log
                break
              fi
              echo "‚è≥ Belum muncul... tunggu 5 detik lagi."
              sleep 5
            done
            echo "üìú Log akhir:"
            tail -n 20 /tmp/tunnel.log || true

      - run:
          name: Keepalive job
          command: |
            echo "‚úÖ XRDP & Cloudflare aktif."
            echo "Gunakan URL di atas pada Remote Desktop Client (user: circleci / password: circleci)"
            while true; do
              echo "[KEEPALIVE] XRDP aktif - $(date)"
              sleep 300
            done

workflows:
  version: 2
  run:
    jobs:
      - run-xrdp-cloudflare
