version: 2.1

jobs:
  run-xrdp-cloudflare:
    docker:
      - image: cimg/base:stable
    resource_class: medium

    steps:
      - checkout

      - run:
          name: Instal XRDP dan Desktop XFCE
          command: |
            sudo apt-get update
            sudo apt-get install -y xrdp xfce4 wget net-tools
            echo "circleci:circleci" | sudo chpasswd

      - run:
          name: Instalasi cloudflared
          command: |
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            cloudflared --version

      - run:
          name: Jalankan XRDP manual (tanpa systemd)
          background: true
          command: |
            # Start XRDP service directly, without systemd
            sudo /usr/sbin/xrdp-sesman &
            sudo /usr/sbin/xrdp --nodaemon &
            sleep 5
            echo "Periksa apakah port 3389 menyala:"
            sudo netstat -tlnp | grep 3389 || echo "‚ö†Ô∏è XRDP belum listening!"

      - run:
          name: Jalankan Cloudflare Tunnel
          background: true
          command: |
            echo "Menunggu hingga XRDP siap..."
            for i in {1..10}; do
              if sudo netstat -tlnp | grep 3389; then
                echo "‚úÖ XRDP ready!"
                break
              fi
              sleep 2
            done
            # Jalankan cloudflared dan log output
            cloudflared tunnel --url tcp://localhost:3389 --loglevel info | tee tunnel.log

      - run:
          name: Tampilkan URL Publik Cloudflare
          command: |
            echo "Menunggu tunnel aktif..."
            for i in {1..20}; do
              if grep -E "trycloudflare.com" tunnel.log; then
                echo "‚úÖ Tunnel publik ditemukan:"
                grep -E "tcp://.*trycloudflare.com" tunnel.log
                break
              fi
              echo "‚è≥ Belum muncul... tunggu 5‚ÄØdetik lagi."
              sleep 5
            done
            echo "üìú Log akhir:"
            tail -n 20 tunnel.log

      - run:
          name: Keep‚Äëalive‚ÄØagar‚ÄØpipeline‚ÄØtidak‚ÄØsleep
          command: |
            echo "‚úÖ XRDP & Cloudflare Tunnel aktif."
            echo "üåê Gunakan alamat tcp://...trycloudflare.com yang tercetak di atas di Remote Desktop Client."
            echo "  User: circleci  Password: circleci"
            echo "üïì Lingkungan ini bertahan hingga kamu Cancel job di CircleCI Dashboard."
            while true; do
              echo "[KEEPALIVE] XRDP masih aktif - $(date)"
              sleep 9999999
            done

workflows:
  version: 2
  run:
    jobs:
      - run-xrdp-cloudflare
